import { FailureAnalysis } from './analyzer'

const SEVERITY_EMOJI = {
  critical: 'ğŸ”´',
  warning: 'ğŸŸ¡',
  info: 'ğŸ”µ'
}

const SEVERITY_LABEL = {
  critical: 'Critical',
  warning: 'Warning',
  info: 'Info'
}

export function formatPRComment(analysis: FailureAnalysis, jobName: string, runUrl: string): string {
  const emoji = SEVERITY_EMOJI[analysis.severity]
  const label = SEVERITY_LABEL[analysis.severity]

  const exactMatchBlock = analysis.exactMatchLine
    ? `\n### ğŸ¯ Exact Error Line ${analysis.exactMatchLineNumber > 0 ? `*(line ${analysis.exactMatchLineNumber} of ${analysis.totalLines})*` : ''}
\`\`\`
${analysis.exactMatchLine}
\`\`\``
    : ''

  const errorBlock = analysis.errorLines.length > 0
    ? `\n<details>\n<summary>ğŸ“‹ All error lines detected (${analysis.errorLines.length})</summary>\n\n\`\`\`\n${analysis.errorLines.join('\n')}\n\`\`\`\n</details>`
    : ''

  const aiNote = analysis.aiGenerated
    ? `\n> ğŸ¤– *This analysis was generated by GitHub Models AI*\n`
    : ''

  return `## ${emoji} AI FaillogLens â€” Failure Analysis

> **Job:** \`${jobName}\` Â· **Severity:** ${label} Â· **Scanned:** ${analysis.totalLines} log lines Â· [View full logs](${runUrl})

---

### ğŸ” Root Cause
${analysis.rootCause}
${aiNote}
### ğŸ“ Failed Step
\`${analysis.failedStep}\`
${exactMatchBlock}

### ğŸ’¡ Suggested Fix
${analysis.suggestion}
${errorBlock}

---
<sub>ğŸ”¬ Analyzed by [AI FaillogLens](https://github.com/SKCloudOps/ai-faillog-lens) Â· [Report false positive](https://github.com/SKCloudOps/ai-faillog-lens/issues)</sub>`
}

export function formatJobSummary(
  analysis: FailureAnalysis,
  jobName: string,
  runUrl: string,
  steps: { name: string; conclusion: string | null; started_at?: string | null; completed_at?: string | null }[],
  triggeredBy: string,
  branch: string,
  commit: string,
  repo: string
): string {
  const emoji = SEVERITY_EMOJI[analysis.severity]
  const label = SEVERITY_LABEL[analysis.severity]
  const now = new Date().toUTCString()

  // Step breakdown
  const stepRows = steps.map(step => {
    const icon =
      step.conclusion === 'success' ? 'âœ…' :
      step.conclusion === 'failure' ? 'âŒ' :
      step.conclusion === 'skipped' ? 'â­ï¸' :
      step.conclusion === 'cancelled' ? 'ğŸš«' : 'â³'

    const duration = step.started_at && step.completed_at
      ? `${Math.round((new Date(step.completed_at).getTime() - new Date(step.started_at).getTime()) / 1000)}s`
      : 'â€”'

    const isFailedStep = step.name === analysis.failedStep
      ? ' â† **failure here**'
      : ''

    return `| ${icon} | \`${step.name}\` | ${step.conclusion ?? 'in progress'} | ${duration} |${isFailedStep}`
  }).join('\n')

  // Top 10 error lines only in summary
  const topErrorLines = analysis.errorLines
    .slice(0, 10)
    .join('\n')

  const aiNote = analysis.aiGenerated
    ? `> ğŸ¤– This suggestion was generated by **GitHub Models AI** (confidence: see suggestion)\n\n`
    : `> ğŸ¯ Matched pattern: \`${analysis.matchedPattern}\` Â· Category: \`${analysis.category}\`\n\n`

  return `# ${emoji} AI FaillogLens â€” Failure Report

---

## ğŸ“Š Run Overview

| | |
|---|---|
| **Repository** | \`${repo}\` |
| **Branch** | \`${branch}\` |
| **Commit** | [\`${commit.substring(0, 7)}\`](https://github.com/${repo}/commit/${commit}) |
| **Triggered By** | \`${triggeredBy}\` |
| **Job** | \`${jobName}\` |
| **Severity** | ${emoji} ${label} |
| **Log Lines Scanned** | ${analysis.totalLines.toLocaleString()} lines |
| **Analyzed At** | ${now} |
| **Full Logs** | [View on GitHub Actions â†—](${runUrl}) |

---

## ğŸ” Root Cause

> ### ${analysis.rootCause}

${aiNote}

---

## ğŸ¯ Exact Error

${analysis.exactMatchLineNumber > 0
  ? `Found on **line ${analysis.exactMatchLineNumber}** of ${analysis.totalLines.toLocaleString()}:`
  : 'Top error line detected:'}

\`\`\`
${analysis.exactMatchLine || 'No exact match found'}
\`\`\`

---

## ğŸ’¡ Suggested Fix

${analysis.suggestion}

---

## ğŸ—‚ï¸ Step Breakdown

| Status | Step | Result | Duration |
|---|---|---|---|
${stepRows}

---

## ğŸ“‹ Error Lines (top 10 of ${analysis.errorLines.length})

\`\`\`
${topErrorLines || 'No error lines captured'}
\`\`\`

---

## ğŸ› ï¸ Quick Actions

| Action | Link |
|---|---|
| ğŸ”— View full workflow run | [Open â†—](${runUrl}) |
| ğŸ“‹ Add custom pattern | [patterns.json â†—](https://github.com/${repo}/blob/main/patterns.json) |
| ğŸ› Report false positive | [Open issue â†—](https://github.com/SKCloudOps/ai-faillog-lens/issues) |
| ğŸ“– Documentation | [README â†—](https://github.com/SKCloudOps/ai-faillog-lens#readme) |

---

<sub>ğŸ”¬ Analyzed by <a href="https://github.com/SKCloudOps/ai-faillog-lens">AI FaillogLens</a> Â· ${now}</sub>`
}
